# 特性マッピング設計ドキュメント

## 1. 設計方針

### 1.1 目的

特性マッピングは、PokeAPIから取得した特性データに対して、適切な`triggerEvent`と`effectCategory`を設定するためのマッピングテーブルである。シードデータ作成時に、特性のメタデータを正しく設定することで、バトルエンジンが特性を適切に処理できるようにする。

### 1.2 設計原則

1. **データとロジックの分離**: DBには特性のメタデータ（`triggerEvent`、`effectCategory`）のみ保存し、ロジックはアプリケーション側で管理する
2. **拡張性**: 新しい特性を追加しやすい構造を維持する
3. **メンテナンス性**: 特性の追加・修正が容易な設計
4. **整合性**: 特性マッピングと特性ロジックの実装の整合性を保つ

### 1.3 現在の構造

```typescript
const abilityMetadataMap: Record<string, AbilityMetadata> = {
  いかく: {
    triggerEvent: 'OnEntry',
    effectCategory: 'StatChange',
  },
  マルチスケイル: {
    triggerEvent: 'OnTakingDamage',
    effectCategory: 'DamageModify',
  },
};
```

- **キー**: 特性の日本語名（DBの`name`フィールドと一致）
- **値**: `AbilityMetadata`オブジェクト（`triggerEvent`と`effectCategory`を含む）
- **デフォルト値**: マッピングされていない特性は`Other`が使用される

## 2. 特性分類の基準

### 2.1 triggerEvent（発動タイミング）の分類基準

特性の発動タイミングに基づいて分類する。

#### OnEntry（場に出すとき）
- **定義**: ポケモンが場に出たときに1回だけ発動する特性
- **例**:
  - いかく: 相手の攻撃ランクを1段階下げる
  - あめふらし: 雨を降らせる
  - ひでり: 晴れにする
  - すなあらし: 砂嵐を起こす

#### OnTakingDamage（ダメージを受けるとき）
- **定義**: ダメージを受けるタイミングで発動する特性
- **例**:
  - マルチスケイル: HP満タン時、受けるダメージ半減
  - ちくでん: でんきタイプの技を無効化してHP回復
  - もらいび: ほのおタイプの技を無効化してほのお技強化
  - あついしぼう: ほのお・こおりタイプのダメージ半減

#### OnDealingDamage（ダメージを与えるとき）
- **定義**: ダメージを与えるタイミングで発動する特性
- **例**:
  - はがねつかい: はがねタイプの技の威力1.5倍

#### OnTurnEnd（ターン終了時）
- **定義**: ターン終了時に発動する特性
- **例**:
  - しんりょく: HPが1/3以下になると、くさタイプの技の威力1.5倍

#### OnSwitchOut（場から下がるとき）
- **定義**: ポケモンが場から下がるときに発動する特性
- **例**:
  - いとあみ: 場から下がるとき、相手の素早さを下げる

#### Passive（常時発動）
- **定義**: 常時発動する特性（無効化されない限り）
- **例**:
  - ふゆう: じめんタイプの技を無効化
  - すいすい: 雨の時、素早さ2倍
  - ようりょくそ: 晴れの時、素早さ2倍
  - すなかき: 砂嵐の時、素早さ2倍

#### OnStatusCondition（状態異常になったとき）
- **定義**: 状態異常になったときに発動する特性
- **例**:
  - ふみん: ねむり無効化
  - どんかん: メロメロ・あくび無効化

#### Other（その他）
- **定義**: 上記のいずれにも該当しない特性、または複雑な発動タイミングを持つ特性
- **例**: 特殊な条件で発動する特性など

### 2.2 effectCategory（効果カテゴリ）の分類基準

特性の効果の種類に基づいて分類する。

#### StatChange（ステータス変化）
- **定義**: ステータスランクやステータス値を変更する特性
- **例**:
  - いかく: 相手の攻撃ランクを1段階下げる
  - すいすい: 雨の時、素早さ2倍
  - ようりょくそ: 晴れの時、素早さ2倍

#### Immunity（無効化）
- **定義**: 特定の技や状態異常を無効化する特性
- **例**:
  - ふみん: ねむり無効化
  - ふゆう: じめんタイプ無効化
  - ちくでん: でんきタイプ無効化
  - もらいび: ほのおタイプ無効化

#### Weather（天候）
- **定義**: 天候を変更する特性
- **例**:
  - あめふらし: 雨を降らせる
  - ひでり: 晴れにする
  - すなあらし: 砂嵐を起こす
  - ゆきふらし: あられを降らせる

#### DamageModify（ダメージ修正）
- **定義**: ダメージを修正する特性
- **例**:
  - マルチスケイル: HP満タン時、受けるダメージ半減
  - あついしぼう: ほのお・こおりタイプのダメージ半減
  - はがねつかい: はがねタイプの技の威力1.5倍

#### StatusCondition（状態異常）
- **定義**: 状態異常を付与する特性
- **例**:
  - どくどく: 攻撃した相手をどくにする

#### Other（その他）
- **定義**: 上記のいずれにも該当しない特性
- **例**: 複雑な効果を持つ特性など

### 2.3 triggerEventとeffectCategoryの組み合わせパターン

特性は`triggerEvent`と`effectCategory`の組み合わせで分類される。一般的な組み合わせパターンは以下の通り：

| triggerEvent | effectCategory | 特性例 |
|-------------|---------------|--------|
| OnEntry | StatChange | いかく |
| OnEntry | Weather | あめふらし、ひでり、すなあらし、ゆきふらし |
| OnTakingDamage | DamageModify | マルチスケイル、あついしぼう |
| OnTakingDamage | Immunity | ちくでん、もらいび、ちょすい |
| OnDealingDamage | DamageModify | はがねつかい |
| Passive | Immunity | ふゆう |
| Passive | StatChange | すいすい、ようりょくそ、すなかき |
| OnStatusCondition | Immunity | ふみん、どんかん |

## 3. 特性マッピングの構造

### 3.1 現在の構造の妥当性

現在の`Record<string, AbilityMetadata>`構造は以下の理由で適切である：

1. **シンプル**: 特性名をキーとして直接マッピングできる
2. **拡張性**: 新しい特性を追加する際に、単純にレコードを追加するだけ
3. **型安全性**: TypeScriptの型システムにより、`AbilityMetadata`の構造が保証される
4. **パフォーマンス**: O(1)のルックアップ時間

### 3.2 改善案

将来的に以下の改善を検討できる：

1. **コメントの追加**: 各特性の説明をコメントで追加し、メンテナンス性を向上
2. **グループ化**: 特性をカテゴリごとにグループ化して整理
3. **バリデーション**: マッピングの整合性をチェックするバリデーション関数の追加

## 4. 特性追加の手順

### 4.1 新しい特性を追加する際の手順

1. **特性の効果を理解する**
   - PokeAPIから取得した特性データを確認
   - 特性の効果を理解し、適切な`triggerEvent`と`effectCategory`を決定

2. **マッピングを追加**
   - `ability-mapping.ts`の`abilityMetadataMap`に新しいエントリを追加
   - キーは特性の日本語名（DBの`name`フィールドと一致させる）

3. **テストを追加**
   - 追加した特性のマッピングが正しく動作することを確認するテストを追加

4. **特性ロジックの実装（必要に応じて）**
   - バトルエンジンで使用する特性の場合は、特性ロジッククラスを実装
   - `AbilityRegistry`に登録

### 4.2 チェックリスト

新しい特性を追加する際に確認すべき項目：

- [ ] 特性の日本語名が正しいか（DBの`name`フィールドと一致するか）
- [ ] `triggerEvent`が適切か（特性の発動タイミングと一致するか）
- [ ] `effectCategory`が適切か（特性の効果の種類と一致するか）
- [ ] 既存の特性との整合性が保たれているか
- [ ] テストが追加されているか

## 5. 特性ロジック実装の優先順位

### 5.1 優先順位の基準

特性ロジックの実装は以下の基準で優先順位を決定する：

1. **バトルエンジンでの使用頻度**: よく使われる特性を優先
2. **実装の容易さ**: 既存の基底クラスを活用できる特性を優先
3. **バトルへの影響度**: バトルの勝敗に大きく影響する特性を優先

### 5.2 優先順位の高い特性

#### 優先度: 高

1. **ふみん（Insomnia）**
   - 理由: 状態異常無効化の代表的な特性
   - 実装: 状態異常無効化の基底クラスが必要

2. **ふゆう（Levitate）**
   - 理由: タイプ無効化の代表的な特性
   - 実装: タイプ無効化の基底クラスが必要

3. **すいすい（Swift Swim）**
   - 理由: 天候依存のステータス変化の代表的な特性
   - 実装: 天候依存のステータス変化の基底クラスが必要

#### 優先度: 中

4. **ちくでん（Volt Absorb）**
   - 理由: タイプ無効化とHP回復の複合効果
   - 実装: タイプ無効化とHP回復の両方を実装する必要がある

5. **もらいび（Flash Fire）**
   - 理由: タイプ無効化とダメージ強化の複合効果
   - 実装: タイプ無効化とダメージ強化の両方を実装する必要がある

6. **あついしぼう（Thick Fat）**
   - 理由: ダメージ修正の代表的な特性
   - 実装: 既存の`BaseConditionalDamageEffect`を活用できる可能性がある

#### 優先度: 低

7. **天候系特性（あめふらし、ひでり、すなあらし、ゆきふらし）**
   - 理由: 天候変更の実装が必要
   - 実装: 天候変更のロジックを実装する必要がある

8. **その他の特性**
   - 理由: 使用頻度が低い、または実装が複雑
   - 実装: 必要に応じて段階的に実装

## 6. 特性マッピングの拡充計画

### 6.1 フェーズ1: 主要な特性の追加

以下のカテゴリから主要な特性を追加：

- **状態異常無効化系**: ふみん、どんかん
- **タイプ無効化系**: ふゆう、ちくでん、もらいび、ちょすい
- **ダメージ修正系**: あついしぼう、はがねつかい
- **ステータス変化系**: すいすい、ようりょくそ、すなかき
- **天候系**: あめふらし、ひでり、すなあらし、ゆきふらし

### 6.2 フェーズ2: 特性ロジックの実装

特性マッピングを追加した特性のうち、バトルエンジンで使用する特性について、特性ロジッククラスを実装し、`AbilityRegistry`に登録する。

### 6.3 フェーズ3: その他の特性の追加

残りの特性についても、段階的にマッピングを追加する。

## 7. メンテナンス

### 7.1 定期的な見直し

特性マッピングは定期的に見直し、以下の点を確認する：

- 新しく追加された特性がマッピングされているか
- 既存のマッピングが正しいか
- 特性ロジックとの整合性が保たれているか

### 7.2 ドキュメントの更新

特性マッピングを追加・修正した際は、このドキュメントも更新する。

